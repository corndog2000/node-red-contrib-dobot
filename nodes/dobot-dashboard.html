<script type="text/javascript">
    RED.nodes.registerType('dobot-dashboard', {
        category: 'dobot',
        color: '#87D8F5',
        defaults: {
            name: {value: ""},
            connection: {value: "", type: "dobot-connection", required: true},
            command: {value: "EnableRobot", required: true},
            parameter: {value: ""}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-robot",
        label: function() {
            return this.name || this.command || "dobot dashboard";
        },
        paletteLabel: "dashboard",
        oneditprepare: function() {
            // Update parameter field based on command selection
            $("#node-input-command").on("change", function() {
                const cmd = $(this).val();
                const paramRow = $("#param-row");
                const paramLabel = $("#param-label");
                const paramInput = $("#node-input-parameter");
                const paramHelp = $("#param-help");
                
                // Commands that need parameters
                const paramCommands = {
                    "SpeedFactor": {label: "Speed", help: "Speed factor (1-100)", type: "number", default: "50"},
                    "User": {label: "Index", help: "User coordinate index (0-9)", type: "number", default: "0"},
                    "Tool": {label: "Index", help: "Tool coordinate index (0-9)", type: "number", default: "0"},
                    "AccJ": {label: "Acceleration", help: "Joint acceleration ratio (1-100)", type: "number", default: "50"},
                    "AccL": {label: "Acceleration", help: "Linear acceleration ratio (1-100)", type: "number", default: "50"},
                    "SpeedJ": {label: "Speed", help: "Joint speed ratio (1-100)", type: "number", default: "50"},
                    "SpeedL": {label: "Speed", help: "Linear speed ratio (1-100)", type: "number", default: "50"},
                    "Arch": {label: "Index", help: "Jump parameter index (0-9)", type: "number", default: "0"},
                    "CP": {label: "Ratio", help: "Smooth transition ratio (1-100)", type: "number", default: "50"},
                    "LimZ": {label: "Height", help: "Maximum lifting height (mm)", type: "number", default: "200"}
                };
                
                if (paramCommands[cmd]) {
                    paramRow.show();
                    paramLabel.text(paramCommands[cmd].label);
                    paramInput.attr("type", paramCommands[cmd].type);
                    paramInput.attr("placeholder", paramCommands[cmd].default);
                    paramHelp.text(paramCommands[cmd].help);
                } else {
                    paramRow.hide();
                    paramInput.val("");
                }
            }).trigger("change");
        }
    });
</script>

<script type="text/html" data-template-name="dobot-dashboard">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-plug"></i> Connection</label>
        <input type="text" id="node-input-connection">
    </div>
    <div class="form-row">
        <label for="node-input-command"><i class="fa fa-cog"></i> Command</label>
        <select id="node-input-command">
            <optgroup label="Robot Control">
                <option value="EnableRobot">Enable Robot</option>
                <option value="DisableRobot">Disable Robot</option>
                <option value="ClearError">Clear Error</option>
                <option value="ResetRobot">Reset Robot</option>
            </optgroup>
            <optgroup label="Speed & Acceleration">
                <option value="SpeedFactor">Speed Factor</option>
                <option value="AccJ">Joint Acceleration</option>
                <option value="AccL">Linear Acceleration</option>
                <option value="SpeedJ">Joint Speed</option>
                <option value="SpeedL">Linear Speed</option>
            </optgroup>
            <optgroup label="Coordinate System">
                <option value="User">User Coordinate</option>
                <option value="Tool">Tool Coordinate</option>
            </optgroup>
            <optgroup label="Parameters">
                <option value="PayLoad">Set Payload</option>
                <option value="DO">Digital Output</option>
                <option value="Arch">Jump Parameters</option>
                <option value="CP">Smooth Transition</option>
                <option value="LimZ">Z Limit</option>
            </optgroup>
            <optgroup label="Status">
                <option value="RobotMode">Robot Mode</option>
                <option value="GetErrorID">Get Error ID</option>
            </optgroup>
            <option value="custom">Custom Command</option>
        </select>
    </div>
    <div class="form-row" id="param-row" style="display:none;">
        <label for="node-input-parameter"><i class="fa fa-sliders"></i> <span id="param-label">Parameter</span></label>
        <input type="text" id="node-input-parameter">
        <div class="form-tips" id="param-help" style="margin-top: 5px;"></div>
    </div>
</script>

<script type="text/html" data-help-name="dobot-dashboard">
    <p>Control and configure Dobot robot using dashboard commands.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">various</span></dt>
        <dd>Command-specific parameter or custom command string</dd>
        <dt class="optional">command <span class="property-type">string</span></dt>
        <dd>Override the configured command</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string</span></dt>
        <dd>Response from the robot</dd>
        <dt>command <span class="property-type">string</span></dt>
        <dd>The command that was executed</dd>
        <dt>raw <span class="property-type">string</span></dt>
        <dd>The raw command string sent to robot</dd>
    </dl>
    <h3>Details</h3>
    <p>This node provides access to robot control and configuration commands.</p>
    <h4>Special Commands:</h4>
    <ul>
        <li><b>PayLoad</b> - Expects <code>msg.payload = {weight: number, inertia: number}</code></li>
        <li><b>DO</b> - Expects <code>msg.payload = {index: 1-24, status: 0|1}</code></li>
        <li><b>Custom</b> - Send any command string via <code>msg.payload</code></li>
    </ul>
</script>